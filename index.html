<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>トロンボーン音声 Base64 外部読み込み</title>
<style>
  /* スタイルは先ほどと同じでOK */
</style>
</head>
<body>
<h1>トロンボーン音声 Base64 外部読み込みデモ</h1>
<p>スライダーで音の高さを変え、ボタンで再生/停止します。</p>

<div id="info">読み込み中…</div>
<input type="range" id="pitchSlider" min="1" max="7" step="0.01" value="1" disabled />
<button id="playBtn" disabled>再生</button>

<script src="base64AudioData.js"></script> <!-- 先に読み込む -->
<script>
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  let buffer = null;
  let source = null;
  let gainNode = null;
  let isPlaying = false;

  const info = document.getElementById("info");
  const slider = document.getElementById("pitchSlider");
  const playBtn = document.getElementById("playBtn");

  function base64ToArrayBuffer(base64) {
    const binaryString = atob(base64);
    const len = binaryString.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
      bytes[i] = binaryString.charCodeAt(i);
    }
    return bytes.buffer;
  }

  function getFreq(pos) {
    const baseFreq = 440;
    return baseFreq / Math.pow(2, (pos - 1) / 6);
  }
  function getPlaybackRate(pos) {
    return getFreq(pos) / 440;
  }

  async function loadAudioFromBase64(base64) {
    try {
      const arrayBuffer = base64ToArrayBuffer(base64);
      const decoded = await audioCtx.decodeAudioData(arrayBuffer);
      return decoded;
    } catch (e) {
      info.textContent = "音声のデコードに失敗しました";
      console.error(e);
      return null;
    }
  }

  function startSound() {
    if (isPlaying || !buffer) return;
    if (audioCtx.state === "suspended") {
      audioCtx.resume();
    }
    source = audioCtx.createBufferSource();
    source.buffer = buffer;
    source.loop = true;

    const rate = getPlaybackRate(parseFloat(slider.value));
    source.playbackRate.setValueAtTime(rate, audioCtx.currentTime);

    gainNode = audioCtx.createGain();
    gainNode.gain.setValueAtTime(0.8, audioCtx.currentTime);

    source.connect(gainNode).connect(audioCtx.destination);
    source.start();

    isPlaying = true;
    playBtn.textContent = "停止";
    info.textContent = `ポジション: ${slider.value} | ピッチ倍率: ${rate.toFixed(2)}`;
  }

  function stopSound() {
    if (!isPlaying) return;
    source.stop();
    source.disconnect();
    gainNode.disconnect();
    source = null;
    gainNode = null;
    isPlaying = false;
    playBtn.textContent = "再生";
    info.textContent = "停止中";
  }

  slider.addEventListener("input", () => {
    if (isPlaying && source) {
      const rate = getPlaybackRate(parseFloat(slider.value));
      source.playbackRate.linearRampToValueAtTime(rate, audioCtx.currentTime + 0.05);
      info.textContent = `ポジション: ${slider.value} | ピッチ倍率: ${rate.toFixed(2)}`;
    }
  });

  playBtn.addEventListener("click", () => {
    if (isPlaying) {
      stopSound();
    } else {
      startSound();
    }
  });

  (async () => {
    // base64AudioDataは外部ファイルでwindowにセット済み
    buffer = await loadAudioFromBase64(window.base64AudioData);
    if(buffer) {
      info.textContent = "読み込み完了！";
      playBtn.disabled = false;
      slider.disabled = false;
    } else {
      info.textContent = "読み込み失敗";
      playBtn.disabled = true;
      slider.disabled = true;
    }
  })();
</script>
</body>
</html>
